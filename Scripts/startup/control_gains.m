% /****************************************************************************
%  *
%  *    Copyright (C) 2024  Yevhenii Kovryzhenko. All rights reserved.
%  *
%  *    This program is free software: you can redistribute it and/or modify
%  *    it under the terms of the GNU Affero General Public License as published by
%  *    the Free Software Foundation, either version 3 of the License, or
%  *    (at your option) any later version.
%  *
%  *    This program is distributed in the hope that it will be useful,
%  *    but WITHOUT ANY WARRANTY; without even the implied warranty of
%  *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%  *    GNU Affero General Public License Version 3 for more details.
%  *
%  *    You should have received a copy of the
%  *    GNU Affero General Public License Version 3
%  *    along with this program.  If not, see <https://www.gnu.org/licenses/>.
%  *
%  *    1. Redistributions of source code must retain the above copyright
%  *       notice, this list of conditions, and the following disclaimer.
%  *    2. Redistributions in binary form must reproduce the above copyright
%  *       notice, this list of conditions, and the following disclaimer in
%  *       the documentation and/or other materials provided with the
%  *       distribution.
%  *    3. No ownership or credit shall be claimed by anyone not mentioned in
%  *       the above copyright statement.
%  *    4. Any redistribution or public use of this software, in whole or in part,
%  *       whether standalone or as part of a different project, must remain
%  *       under the terms of the GNU Affero General Public License Version 3,
%  *       and all distributions in binary form must be accompanied by a copy of
%  *       the source code, as stated in the GNU Affero General Public License.
%  *
%  ****************************************************************************/

%% control gains
Parameters.Control.Gains.K_pos = zeros(3,3);
Parameters.Control.Gains.K_pos_int = zeros(3);
Parameters.Control.Gains.K_vel = zeros(3,3);
Parameters.Control.Gains.K_acc = zeros(3,3);
Parameters.Control.Gains.K_att = zeros(3,3);
Parameters.Control.Gains.K_omega = zeros(3,3);
Parameters.Control.Gains.K_omega_I = zeros(3,3);
Parameters.Control.Gains.K_omega_dot = zeros(3,3);

% Parameters.Control.Gains.K_pos(:) = diag([4.8,4.8,35]);
% Parameters.Control.Gains.K_pos_int(:) = diag([0.4, 0.4, 3.0]);
% Parameters.Control.Gains.K_vel(:) = diag([5,5,33]);
% Parameters.Control.Gains.K_acc(:) = diag([1,1,5]*1E-2);
% Parameters.Control.Gains.K_att(:,:) = diag([25.0, 25.0, 20]);
% Parameters.Control.Gains.K_omega(:,:) = diag([12, 12, 8]);


%old new
% Parameters.Control.Gains.K_pos(:)           = diag([4.30, 4.30, 30]);
% Parameters.Control.Gains.K_pos_int(:)       = diag([0.35, 0.35, 0.05]);
% Parameters.Control.Gains.K_vel(:)           = diag([4.50, 4.50, 70]);
% Parameters.Control.Gains.K_acc(:)           = diag([0.10, 0.10, 10]);

%new gains:
Parameters.Control.Gains.K_pos(:)           = diag([0.6, 0.6, 1.0]);
Parameters.Control.Gains.K_pos_int(:)       = diag([1.3, 1.3, 2.0]);
Parameters.Control.Gains.K_vel(:)           = diag([1.3, 1.3, 2.0]);
Parameters.Control.Gains.K_acc(:)           = diag([0.2, 0.2, 0.11]);
Parameters.Control.Gains.K_att(:,:)         = diag([3.0, 3.0, 0.1]);
Parameters.Control.Gains.K_omega(:,:)       = diag([1.1, 1.1, 0.09]);
Parameters.Control.Gains.K_omega_I(:,:)     = diag([0.01, 0.01, 0.01]);
Parameters.Control.Gains.K_omega_dot(:,:)   = diag([0.008, 0.008, 0.005]);

FLIGHT_MODE = flight_mode.autonomous;
% FLIGHT_MODE = flight_mode.attitude_control;
% FLIGHT_MODE = flight_mode.position_hold;
% FLIGHT_MODE = flight_mode.position_control;

Parameters.Control.Gains.MANUAL_ROLL_STICK_GAIN = pi/3;
Parameters.Control.Gains.MANUAL_PITCH_STICK_GAIN = pi/3;
Parameters.Control.Gains.MANUAL_YAW_RATE_STICK_GAIN = pi/6;
Parameters.Control.Gains.MANUAL_THRUST_STICK_GAIN = 1;

Parameters.Control.Gains.VELOCITY_XY_STICK_GAIN = 3;
Parameters.Control.Gains.VELOCITY_Z_STICK_GAIN = 1;

Parameters.K_Control.EN = false;
Parameters.K_Control.K_pos_int = zeros(6);
Parameters.K_Control.K_pos_int = diag([0.3, 0.3, 0.5, 0.0, 0.0, 0.2]);
Parameters = get_K_matrix_params(Parameters, p_0, v_0, att_0, omega_0);

function Parameters = get_K_matrix_params(Parameters, p_0, v_0, att_0, omega_0)
use_LQR_gains = true;

if use_LQR_gains
    % K_LQR = [-5.46173880523571e-14,6.90683083581479e-15,-3.12702453757741,-3.27211495346751e-14,-7.05707291812518e-15,-4.02215114210801,-7.42638349618150e-14,9.80265435900625e-14,-1.49348208426945e-14,-3.17410663804656e-15,-1.67305052129051e-15,-1.58577983332528e-15;-1.76786540880850e-05,0.359284122703794,5.52340427238086e-15,-2.74195558614732e-05,0.485818210685918,2.31716148811047e-15,2.34102655429959,0.000162055343151039,8.65373874976366e-06,0.572521184648139,5.11154554414006e-05,1.31595912329116e-05;-0.386519570585021,1.76787078877260e-05,-7.63762851644878e-15,-0.528059914111298,2.74196310286153e-05,-1.66471278749048e-15,0.000162055719750096,2.59068072927525,2.52062232661390e-05,5.11155466196404e-05,0.651266006639211,3.90872413004644e-05;-4.90594559222049e-06,3.38077306388272e-06,-2.23937477924831e-15,-9.27561449014939e-06,5.25875593359734e-06,-1.84724222076310e-15,3.12948670560956e-05,6.79174224824429e-05,0.363736954230062,1.00600353393518e-05,2.62231676609191e-05,0.524588724433675];
    K_LQR = [-0.108986759048268,-0.179611027356810,-3.14401129720504,-0.0968562008325304,-0.159897207457012,-4.09328970461566,-0.295268121978082,0.114845272443531,0.0153775998631839,-0.00580003394397363,0.00542679009479144,-0.0131121474791781;0.00107411820972405,0.399990293762619,-0.0208090736466547,0.000143005401966562,0.448077467259606,-0.0397482345084249,2.28034327358324,-0.0151693544446019,0.194667499223926,0.617950250780789,0.000174407536416486,0.0444011106644467;-0.415941540164628,0.00105933276689221,0.0107861980937412,-0.471819738567850,0.00129686656952614,0.0240703502383800,-0.00390280218931056,2.44085253473459,0.281386185387731,-0.000245946955814455,0.673523753513132,0.0778268796313337;-0.00583204967265814,0.00379082001083740,0.00146920299532755,-0.0105025471624922,0.00661866651148616,0.00499263936754040,0.0587843194252963,0.0771597947595187,0.477018972012736,0.00125206904015803,0.00288376141016204,1.01503632868404];
    % K_LQR = [-0.182114987207686,-0.411947152314022,-2.17772960227112,-0.359367235733698,-0.283073134609367,-1.72846212043343,-0.260666508061607,2.13731093447768,3.95391842808076,-0.0677472208608509,0.322809580726491,9.36537037854850;-0.0132810503255474,0.272346407680110,-0.0538896621319720,-0.00595356587452469,0.246496582017000,-0.0709942587817122,1.04457921997081,-0.0115232431779357,-0.317818842661429,0.326313611475680,-0.00802934898868003,-1.17352698761775;-0.289405533299485,0.0119090677172972,0.0227333112174642,-0.261072855472553,0.00259935044764108,0.00160422324526112,-0.0148041880328134,1.09154562636762,-0.637148897088553,0.00507541188976726,0.344177828950830,-2.18107995057668;0.000481748218801235,-0.000164358137705533,0.00636371423834304,-0.00247968428906352,0.00148373100567962,0.0141746986788127,0.00944003146395005,0.0354179393061940,0.0427472229032365,0.00166730536969009,0.0114201818358449,0.158236001500346];

    Parameters.K_Control.K = K_LQR;
else

    % K_S_LEMMA = [-2.39590939669468,2.62133668276481,2.33934344341726,-5.82715623401929,3.45448549285559,64.5012745247798,12.2481213121017,23.5434872539549,-1.91250519657858,1.15013324398884,6.23359444894196,-1.13160022850384;0.0936307734204171,-0.132362581852509,-0.0892315333711391,0.224176843284110,-0.221345561864674,-2.60271116441909,-1.14559174490242,-0.849555118260600,0.0648684390860106,-0.229682908931863,-0.226518579092068,0.0430011605312224;0.350991238099533,-0.356844714985420,-0.308980433736530,0.873664339684868,-0.462190209532650,-8.84376319514420,-1.58773829660505,-3.93787269247943,0.194170742350351,-0.131873716548782,-1.08924641974999,0.143539192463178;-0.0930531805102106,0.101627573528039,0.0936716778033681,-0.231857418195973,0.131047971227851,2.53004369020996,0.466606000373278,0.916016224500424,-0.427332776498363,0.0408289411846299,0.232149406632804,-0.180067065497235];
    % K_S_LEMMA = [-0.620863073028229,0.913676493887456,1.69619597945998,-0.624403168237931,0.443464376885668,6.06002072769398,2.52319271046138,0.976029061704403,-0.506677942344089,0.376471225629933,0.232307121710217,-230.494106567852;0.157774642092963,-0.264536186399898,-0.404923969377413,0.151439310001569,-0.164303934786550,-1.33295216998750,-1.01585176700209,-0.176492136941900,0.225850195687085,-0.233784634744943,-0.0369353119134482,60.5712002009883;0.132197439869271,-0.148374897604600,-0.254489000045886,0.159829897068844,-0.0639901638171017,-0.841495526392402,-0.351706667395221,-0.618476555966901,0.145349129405087,-0.0472549751946095,-0.224592617947920,38.4496438517480;-0.237009088878114,0.350130382604384,0.584467804775607,-0.237142230512735,0.171485942654761,1.93020426830023,0.964811244512912,0.384777302972056,-0.371690417199154,0.143600595618651,0.0907017984720992,-87.1735956315565];
    % K_S_LEMMA = [-0.354100864255153,0.238475730677115,1.02441713910089,-0.261174482013606,0.0449739071689035,1.68832102440272,1.02512722021947,-0.538337136447525,21.7083607696741,0.115955218745851,0.0974234709265706,215.845193498695;0.0411627772890581,-0.0458562342732039,-0.108446053434009,0.0286083283912238,-0.0410046401785679,-0.106988125078243,-0.401572121923546,0.0815179616394393,-2.59081494714247,-0.130848528865562,-0.00602363986969840,-25.6683102974744;0.0345529769960656,-0.00169458643312670,-0.0103058408770106,0.0652123711232343,0.00184698835939695,-0.00763442275732564,0.00509894711122456,-0.492970554177605,-0.253373818798396,0.00221086104132503,-0.200166750364935,-2.52287485353658;0.214927943584643,-0.148758825246617,-0.552437576999919,0.158304744949358,-0.0291860052852387,-0.584577509462216,-0.623325815305785,0.314308693206242,-13.0759136986535,-0.0711785810305464,-0.0600938478888906,-129.741575955905];
    
    % K_S_LEMMA = [-0.00108420589540410,-0.0193177526231411,0.965783554194216,-0.0146155154905685,-0.0102172447164353,3.03786071544586,-0.0259430752905737,0.0386041221448270,-0.0528718328351496,-0.00164739766846880,0.00308539387746926,-0.0689907337185423;0.00352633097687804,-0.177102801041949,0.00595816477470142,0.00506302324492793,-0.340102762201921,0.0261173067670001,-2.20066346358389,-0.0203471750791461,-0.290921739199767,-0.470006431739126,-0.00292684790707454,-0.807046154234212;0.196610128064415,-0.00384709154936021,-0.00162689920512826,0.375168289674409,-0.00496364167294215,-0.00890199434480901,-0.0154845528293140,-2.49916365679020,0.143651048266540,-0.00157235448010583,-0.560959610968873,0.398353369105169;0.135694437698875,-0.0971354188732579,-0.0300553720247663,0.0809887520660263,0.000106160335829262,0.829514860878074,-0.559820877919610,0.538147058452837,-46.8612719506291,-0.0306048474316471,-0.0360259826773153,-130.918837929156];
    
    % K_S_LEMMA = [0.0750365602726891,-0.120328947400980,1.36653996954348,0.100748430592504,-0.118110977236240,3.52822927792528,-0.877180544226956,-0.523745665865620,-2.11343109490288,-0.0418343275259823,-0.0340124827841475,-5.09642551097461;0.000830732890648687,-0.191323920505252,0.0591003146447301,-0.0238505232222749,-0.356085599966132,0.110639996434310,-2.25750119148505,0.119977135951225,-1.36550637835629,-0.461661109756832,0.0355953665953985,-3.26850147382165;0.135367931321657,0.000334264134344821,0.00371329235520056,0.297048217804411,0.00952785182472008,-0.00861819186626835,0.0851137436393611,-2.11747950957115,-2.01774603798229,0.0222600572639440,-0.488421063523785,-4.96839076539035;0.204560212369124,0.0409910833310203,-0.659734392286754,0.285032669123844,-0.112523871653821,-1.01173167074122,-2.01025005062775,-3.28190960280127,-47.7910975862513,-0.0899778050121885,-0.245944486564181,-132.080610335544];
    % K_S_LEMMA = [1.40965684008940,2.61790279534556,25.7210300170275,1.00573030885444,2.08185682851602,41.7810903330801,5.61284604803282,-0.857944009043276,0.0640597195487352,1.29419958828523,-0.300104287503861,0.157284936298047;-0.0129322601371641,-2.04814216889348,0.126046733696706,-0.0144108921083582,-2.61211259364126,0.308520501932727,-13.0529044800918,0.142713145182067,-0.983293462832494,-2.84723929274116,0.00206058386645141,-0.0430000335338139;3.10640234572202,0.00619903528651393,-0.0893924943771051,3.96343403923571,0.00979259129411058,-0.265208456738295,0.0991899440907447,-19.8638633586410,-2.05631733307733,0.00782835133228802,-4.31506082453595,-0.226545590253740;4.57436884937014,-3.55750422138487,-0.0202228367921677,6.01115737747200,-4.59627449231131,-0.0269355875617240,-19.1740329964636,-25.5479095221277,-24.2318568170317,-3.37069056600331,-4.36059038096324,-21.9687749892949];
    % K_S_LEMMA = [0.104467722831017,0.101409175581717,0.975411391491523,0.0679131588919756,0.126478095659936,2.99590012734937,0.540301079144105,-0.0184307678289614,1.60748889726227,0.0250358631862337,0.00181435442536105,4.44507940869401;-0.0241106212284378,-0.191398715626373,-0.0311992049463404,-0.00775854868320262,-0.349217119273354,-0.0344690697340020,-2.27164216868262,0.0295316036308947,-1.18000742879383,-0.467931699619148,0.0170547119926416,-2.67106108361243;0.194854269068452,0.00574238910251989,-0.0103423382578757,0.371091920564675,-0.00140628481408425,-0.0548139351457664,-0.0679371101994951,-2.40857896813991,-1.91304877111131,0.0102954784545156,-0.522595992776369,-4.45155895180072;-0.117428441383009,0.275869567064480,-0.272051287668805,0.162068784591272,0.169801320115147,-1.15926296282153,-1.95365470577144,-2.05862547495513,-48.3040317279826,-0.0857670636982146,-0.205734786303579,-131.227910779301];
    % K_S_LEMMA = [0.440787948519277,0.119391705191202,1.45144745105388,0.618408612844560,0.123347496696772,2.08172364075180,-0.115470477426844,-2.87901596184222,-6.13602244662145,0.0411746565715893,-0.342211677919201,-7.23405407457360;-0.0109820684240965,-0.219899941235129,0.0228258809895282,-0.0156858321477119,-0.264467189758429,0.0721954577811857,-1.25517895582622,0.0872779351620212,-0.0899156772141027,-0.274330220739323,0.0128168908902375,0.652544541566612;0.192910691108998,0.0143016822348020,-0.0354407951093521,0.234329763249317,0.0196912201601104,-0.0195011084558385,0.0903351404602408,-1.15946066120665,0.0708972580729257,-0.000555823479069249,-0.298068285448022,1.20407457791599;-0.00150076033646409,0.00155448984709277,-0.0102980246345205,0.00397297825275222,-0.00146007421021059,-0.0337415541415048,-0.00902073281538412,-0.0532020740523595,-0.0579299213932434,-0.00148331989177015,-0.0113375315969048,-0.339541886286155];
    % K_S_LEMMA = [0.256925831188523,0.390359216779149,3.32614309514907,0.322898361355477,0.506692480380357,5.22874465361316,-0.123603429930310,0.327565207607647,-1.57793334743184,-0.00410246700657490,0.0157080467837482,-2.88530422237588;0.00407331790454175,-0.714661666788922,0.0844647215285112,0.00634762873332282,-0.869994570997729,0.123405399679516,-4.82413935203986,-0.0175745625586730,0.261337225797400,-0.664865499004568,-0.00274926727252882,0.428000658162844;0.832109157463246,-0.0149687201319120,-0.0551528531258525,1.02509382161639,-0.0198473049325155,-0.0774370590656062,-0.0440784774630357,-5.74890045577625,-1.20591395493849,-0.00146316545351516,-0.815584838755392,-2.27459461844274;0.392681892565677,-0.0203324675330479,0.513471614395314,0.422364450856924,0.0411136539803551,1.45292481423241,0.395773134250299,-2.44474714364473,-70.2256826962307,0.0308749041102219,-0.157835416100072,-132.340258201043];
    
    %good gains:
    K_S_LEMMA = [0.440787948519277,0.119391705191202,1.45144745105388,0.618408612844560,0.123347496696772,2.08172364075180,-0.115470477426844,-2.87901596184222,-6.13602244662145,0.0411746565715893,-0.342211677919201,-7.23405407457360;-0.0109820684240965,-0.219899941235129,0.0228258809895282,-0.0156858321477119,-0.264467189758429,0.0721954577811857,-1.25517895582622,0.0872779351620212,-0.0899156772141027,-0.274330220739323,0.0128168908902375,0.652544541566612;0.192910691108998,0.0143016822348020,-0.0354407951093521,0.234329763249317,0.0196912201601104,-0.0195011084558385,0.0903351404602408,-1.15946066120665,0.0708972580729257,-0.000555823479069249,-0.298068285448022,1.20407457791599;-0.00150076033646409,0.00155448984709277,-0.0102980246345205,0.00397297825275222,-0.00146007421021059,-0.0337415541415048,-0.00902073281538412,-0.0532020740523595,-0.0579299213932434,-0.00148331989177015,-0.0113375315969048,-0.339541886286155];
    
    

    Parameters.K_Control.K = -K_S_LEMMA;    
end
    %% for reduced simulator:
    add_offset  = false;    
    
    p_0  = [0;0;-1]; % initial position
    v_0  = [0;0;0];  % initial velocity
    att_0 = [0;0;0];  % initial angular velocity
    omega_0 = [0;0;0];  % initial Euler angles
    
    T_r = Parameters.Vehicle.m*Parameters.g;
    Tau_r = [0;0;0];


    if add_offset
        Parameters.K_Control.Ref.p = p_0 + [2;2;0];
    else
        Parameters.K_Control.Ref.p = p_0;
    end
    Parameters.K_Control.Ref.v = v_0;
    Parameters.K_Control.Ref.att = att_0;
    Parameters.K_Control.Ref.rates = omega_0;
    Parameters.K_Control.Ref.T = T_r;
    Parameters.K_Control.Ref.Tau = Tau_r;

end